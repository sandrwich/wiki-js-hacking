head: |
  <script>
  (function() {
    if (!/^\/e\//.test(window.location.pathname)) return;

    // ─── CKEditor 5 Footnote Plugin (injected before editor loads) ──
    // Intercepts webpackJsonp to add extraPlugins with schema,
    // converters, and post-fixer before CKEditor.create() is called.
    // footnoteRef is an editable inline element — the text inside IS the ID.

    window.__footnotePluginReady = false;

    function FootnotePlugin(editor) {
      // Schema: editable inline element that contains text
      editor.model.schema.register('footnoteRef', {
        allowWhere: '$text',
        isInline: true,
        isLimit: true,
        allowContentOf: '$block'
      });

      // Editing downcast: model -> editable <sup> in editor
      editor.conversion.for('editingDowncast').elementToElement({
        model: 'footnoteRef',
        view: function(modelElement, viewWriter) {
          return viewWriter.createEditableElement('sup', {
            class: 'footnote-ref'
          });
        }
      });

      // Data downcast: model -> <span class="footnote-marker"> for storage
      editor.conversion.for('dataDowncast').elementToElement({
        model: 'footnoteRef',
        view: function(modelElement, viewWriter) {
          return viewWriter.createContainerElement('span', {
            class: 'footnote-marker'
          });
        }
      });

      // Override getData to replace <span class="footnote-marker">id</span> with [^id]
      var origGetData = editor.getData.bind(editor);
      editor.getData = function(opts) {
        var html = origGetData(opts);
        html = html.replace(/\u200B/g, '');
        html = html.replace(/<span class="footnote-marker">([^<]*)<\/span>/g, '[^$1]');
        html = html.replace(/<span class="footnote-marker"><br[^>]*><\/span>/g, '');
        return html;
      };

      // Upcast: <span class="footnote-marker"> -> model footnoteRef with text child
      editor.conversion.for('upcast').add(function(dispatcher) {
        dispatcher.on('element:span', function(evt, data, conversionApi) {
          var viewElement = data.viewItem;
          if (!viewElement.hasClass('footnote-marker')) return;
          if (!conversionApi.consumable.test(viewElement, { name: true, classes: 'footnote-marker' })) return;

          var modelElement = conversionApi.writer.createElement('footnoteRef');
          if (!conversionApi.safeInsert(modelElement, data.modelCursor)) return;
          conversionApi.consumable.consume(viewElement, { name: true, classes: 'footnote-marker' });

          // Convert children (text) into the model element
          conversionApi.convertChildren(viewElement, modelElement);
          conversionApi.updateConversionResult(modelElement, data);
        });
      });

      // Inject CSS for footnote display in editor
      var style = document.createElement('style');
      style.textContent = [
        'sup.footnote-ref { color: #1976d2; cursor: text; background: #e3f2fd;',
        '  padding: 0 2px; border-radius: 2px; font-weight: bold; font-size: 0.75em;',
        '  outline: none; min-width: 8px; display: inline-block; }',
        'sup.footnote-ref::before { content: "["; pointer-events: none; }',
        'sup.footnote-ref::after { content: "]"; pointer-events: none; }',
        'sup.footnote-ref br[data-cke-filler] { display: none; }',
        '.footnote-def-block { color: #666; font-size: 0.9em;',
        '  border-top: 1px solid #ddd; padding-top: 4px; margin-top: 4px; }'
      ].join(' ');
      document.head.appendChild(style);

      // Post-fixer: auto-convert [^id] typed as plain text into editable element
      editor.model.document.registerPostFixer(function(writer) {
        var root = editor.model.document.getRoot();
        var items = Array.from(writer.createRangeIn(root).getItems());
        for (var i = 0; i < items.length; i++) {
          var item = items[i];
          if (!item.data) continue;
          // Skip text inside a footnoteRef (that's the editable content)
          if (item.parent && item.parent.is && item.parent.is('element', 'footnoteRef')) continue;

          var text = item.data;
          var refMatch = /\[\^(\w+)\](?!:)/.exec(text);
          if (!refMatch) continue;

          // Skip definition lines [^id]: text
          var fullText = '';
          var parent = item.parent;
          if (parent) {
            for (var child of parent.getChildren()) {
              if (child.data) fullText += child.data;
            }
          }
          if (/^\[\^\w+\]:/.test(fullText.trim())) continue;

          try {
            var matchOffset = refMatch.index;
            var matchLen = refMatch[0].length;
            var id = refMatch[1];
            var absOffset = item.startOffset + matchOffset;

            // Create footnoteRef with text child
            var fnRef = writer.createElement('footnoteRef');
            writer.insert(fnRef, parent, absOffset);
            writer.insertText(id, fnRef, 0);
            // Remove the original [^id] text (now shifted by 1 due to insert)
            var removeStart = writer.createPositionAt(parent, absOffset + 1);
            var removeEnd = writer.createPositionAt(parent, absOffset + 1 + matchLen);
            writer.remove(writer.createRange(removeStart, removeEnd));
          } catch(e) {
            console.warn('[Footnote Plugin] Post-fixer error:', e.message);
          }
          return true;
        }
        return false;
      });

      // ZWS placeholder: insert when empty (and cursor not inside), strip when real content exists
      editor.model.document.registerPostFixer(function(writer) {
        var root = editor.model.document.getRoot();
        var sel = editor.model.document.selection.getFirstPosition();
        var cursorParent = sel && sel.parent;
        var changed = false;
        for (var item of writer.createRangeIn(root).getItems()) {
          if (!item.is || !item.is('element', 'footnoteRef')) continue;
          var text = '';
          for (var child of item.getChildren()) {
            if (child.data) text += child.data;
          }
          if (text === '' && item !== cursorParent) {
            writer.insertText('\u200B', item, 0);
            changed = true;
          } else if (text.replace(/\u200B/g, '').length > 0 && text.indexOf('\u200B') >= 0) {
            for (var child of Array.from(item.getChildren())) {
              if (child.data && child.data.indexOf('\u200B') >= 0) {
                var clean = child.data.replace(/\u200B/g, '');
                var offset = child.startOffset;
                writer.remove(child);
                if (clean) writer.insertText(clean, item, offset);
                changed = true;
              }
            }
          }
        }
        return changed;
      });

      window.__footnotePluginReady = true;
      console.log('[Footnote Plugin] Schema + converters registered');
    }
    FootnotePlugin.pluginName = 'FootnotePlugin';

    // ─── Intercept webpack chunk loading ─────────────────────────────
    var wp = window.webpackJsonp = window.webpackJsonp || [];
    var origPush = wp.push.bind(wp);

    wp.push = function(chunk) {
      var modules = chunk[1];
      if (modules) {
        var keys = Object.keys(modules);
        for (var k = 0; k < keys.length; k++) {
          if (keys[k].indexOf('@requarks/ckeditor5') >= 0) {
            console.log('[Footnote Plugin] Intercepted CKEditor module: ' + keys[k]);
            var origFactory = modules[keys[k]];
            modules[keys[k]] = function(orig) {
              return function(module, exports, require) {
                orig.call(this, module, exports, require);
                var Editor = module.exports.default || module.exports;
                if (Editor && Editor.create) {
                  var origCreate = Editor.create;
                  Editor.create = function(element, config) {
                    config = config || {};
                    config.extraPlugins = config.extraPlugins || [];
                    config.extraPlugins.push(FootnotePlugin);
                    console.log('[Footnote Plugin] Injected into CKEditor.create()');
                    return origCreate.call(Editor, element, config);
                  };
                }
              };
            }(origFactory);
            break;
          }
        }
      }
      return origPush(chunk);
    };

    // Also patch already-queued chunks (unlikely but safe)
    for (var i = 0; i < wp.length; i++) {
      var modules = wp[i][1];
      if (!modules) continue;
      var keys = Object.keys(modules);
      for (var k = 0; k < keys.length; k++) {
        if (keys[k].indexOf('@requarks/ckeditor5') >= 0) {
          console.log('[Footnote Plugin] Found CKEditor in pre-queued chunk ' + i);
        }
      }
    }

    console.log('[Footnote Plugin] Webpack hook installed, waiting for editor-ckeditor chunk');
  })();
  </script>
bodyStart: ""
bodyEnd: |
  <script>
  (function() {
    if (!/^\/e\//.test(window.location.pathname)) return;

    // ─── Toolbar button + keyboard shortcut (runs after editor loads) ─

    function getFootnoteText(fnRef) {
      var text = '';
      for (var child of fnRef.getChildren()) {
        if (child.data) text += child.data;
      }
      return text;
    }

    function getNextFootnoteId(editor) {
      var root = editor.model.document.getRoot();
      var max = 0;
      for (var item of editor.model.createRangeIn(root).getItems()) {
        if (item.is && item.is('element', 'footnoteRef')) {
          var n = parseInt(getFootnoteText(item), 10);
          if (n > max) max = n;
        }
        if (item.data) {
          var re = /\[\^(\d+)\]/g;
          var m;
          while ((m = re.exec(item.data)) !== null) {
            var num = parseInt(m[1], 10);
            if (num > max) max = num;
          }
        }
      }
      return max + 1;
    }

    function insertFootnote(editor) {
      var n = getNextFootnoteId(editor);

      editor.model.change(function(writer) {
        // Insert footnoteRef with text child at cursor
        var pos = editor.model.document.selection.getFirstPosition();
        if (pos) {
          if (editor.model.schema.isRegistered('footnoteRef')) {
            var fnRef = writer.createElement('footnoteRef');
            writer.insert(fnRef, pos);
            writer.insertText(String(n), fnRef, 0);
          } else {
            writer.insertText('[^' + n + ']', pos);
          }
        }

        // Append definition to existing block or create new one
        var appendTo = '{{appendTo}}' || 'first';
        var root = editor.model.document.getRoot();
        var defIdx = -1;

        function hasDefinition(idx) {
          var child = root.getChild(idx);
          var text = '';
          for (var item of editor.model.createRangeIn(child).getItems()) {
            if (item.data) text += item.data;
          }
          return /\[\^\w+\]:/.test(text);
        }

        if (appendTo === 'last') {
          for (var i = root.childCount - 1; i >= 0; i--) {
            if (hasDefinition(i)) { defIdx = i; break; }
          }
        } else {
          for (var i = 0; i < root.childCount; i++) {
            if (hasDefinition(i)) { defIdx = i; break; }
          }
        }

        if (defIdx >= 0) {
          var defPara = root.getChild(defIdx);
          var endPos = writer.createPositionAt(defPara, 'end');
          writer.insert(writer.createElement('softBreak'), endPos);
          writer.insertText('[^' + n + ']: ', writer.createPositionAt(defPara, 'end'));
        } else {
          var lastChild = root.getChild(root.childCount - 1);
          var sep = writer.createElement('paragraph');
          writer.insert(sep, writer.createPositionAfter(lastChild));
          var para = writer.createElement('paragraph');
          writer.insertText('[^' + n + ']: ', para, 0);
          writer.insert(para, writer.createPositionAfter(sep));
        }
      });
    }

    function hookEditor(editor) {
      // Toolbar button
      var toolbar = document.querySelector('.ck-toolbar__items');
      if (toolbar) {
        var sep = document.createElement('span');
        sep.className = 'ck ck-toolbar__separator';
        toolbar.appendChild(sep);

        var btn = document.createElement('button');
        btn.className = 'ck ck-button ck-off';
        btn.type = 'button';
        btn.innerHTML = '<span style="font-size: 11px; font-weight: bold; line-height: 1;">f<sup>n</sup></span>';
        btn.style.cssText = 'min-width: 32px; min-height: 32px; display: flex; align-items: center; justify-content: center; cursor: pointer;';
        btn.addEventListener('mousedown', function(e) { e.preventDefault(); });
        btn.addEventListener('click', function() {
          editor.editing.view.focus();
          insertFootnote(editor);
        });
        toolbar.appendChild(btn);

        // Keyboard shortcut
        var keybindStr = '{{keybind}}' || 'Ctrl+Shift+F';
        var parts = keybindStr.split('+').map(function(s) { return s.trim().toLowerCase(); });
        var bindKey = parts.filter(function(p) { return p !== 'ctrl' && p !== 'shift' && p !== 'alt' && p !== 'meta'; })[0] || 'f';
        var needCtrl = parts.indexOf('ctrl') >= 0;
        var needShift = parts.indexOf('shift') >= 0;
        var needAlt = parts.indexOf('alt') >= 0;

        btn.title = 'Insert Footnote (' + keybindStr + ')';

        editor.editing.view.getDomRoot().addEventListener('keydown', function(e) {
          var ctrlOk = needCtrl ? (e.ctrlKey || e.metaKey) : !e.ctrlKey && !e.metaKey;
          var shiftOk = needShift ? e.shiftKey : !e.shiftKey;
          var altOk = needAlt ? e.altKey : !e.altKey;
          if (ctrlOk && shiftOk && altOk && e.key.toLowerCase() === bindKey) {
            e.preventDefault();
            e.stopPropagation();
            insertFootnote(editor);
          }
        }, true);
      }

      // Style definition paragraphs containing [^id]: patterns
      function styleDefinitions() {
        var editable = document.querySelector('.ck-editor__editable');
        if (!editable) return;
        var paras = editable.querySelectorAll('p');
        for (var i = 0; i < paras.length; i++) {
          var text = paras[i].textContent || '';
          if (/\[\^\w+\]:/.test(text)) {
            paras[i].classList.add('footnote-def-block');
          } else {
            paras[i].classList.remove('footnote-def-block');
          }
        }
      }

      var defObserver = new MutationObserver(styleDefinitions);
      var editable = document.querySelector('.ck-editor__editable');
      if (editable) {
        defObserver.observe(editable, { childList: true, subtree: true, characterData: true });
        styleDefinitions();
      }

      var mode = window.__footnotePluginReady ? 'WYSIWYG widgets' : 'plain text';
      console.log('[Footnote Plugin] Ready (' + mode + ')');
    }

    var attempts = 0;
    var poll = setInterval(function() {
      attempts++;
      var el = document.querySelector('.ck-editor__editable');
      if (el && el.ckeditorInstance) {
        clearInterval(poll);
        hookEditor(el.ckeditorInstance);
      }
      if (attempts > 600) clearInterval(poll);
    }, 100);
  })();
  </script>
