javascript:void function(){if(!/^\/e\//.test(location.pathname))return alert("Not on a Wiki.js editor page");function t(l){return/^\s*\|/.test(l)}function s(l){return/^\s*\|[\s:?-]+\|/.test(l)&&/^[\s|:\-]+$/.test(l)}function p(l){var r=l.trim();if(r[0]==="|")r=r.slice(1);if(r[r.length-1]==="|")r=r.slice(0,-1);return r.split("|").map(function(c){return c.trim()})}function f(lines){var rows=[],si=[];for(var i=0;i<lines.length;i++)s(lines[i])?(si.push(i),rows.push(null)):rows.push(p(lines[i]));var mc=0;for(var i=0;i<rows.length;i++)rows[i]&&rows[i].length>mc&&(mc=rows[i].length);if(!mc)return lines;var w=[];for(var c=0;c<mc;c++)w.push(3);for(var i=0;i<rows.length;i++)if(rows[i])for(var c=0;c<rows[i].length;c++)rows[i][c].length>w[c]&&(w[c]=rows[i][c].length);var al=[];for(var c=0;c<mc;c++)al.push("l");if(si.length){var sc=p(lines[si[0]]);for(var c=0;c<sc.length&&c<mc;c++){var x=sc[c].trim(),le=x[0]===":",ri=x[x.length-1]===":";le&&ri?al[c]="c":ri&&(al[c]="r")}}var res=[];for(var i=0;i<rows.length;i++){var pts=[];if(!rows[i]){for(var c=0;c<mc;c++){var d="";for(var j=0;j<w[c];j++)d+="-";al[c]==="c"?pts.push(":"+d+":"):al[c]==="r"?pts.push(" "+d+":"):pts.push(" "+d+" ")}res.push("|"+pts.join("|")+"|")}else{for(var c=0;c<mc;c++){var cell=c<rows[i].length?rows[i][c]:"",pd=w[c]-cell.length,ps="";for(var j=0;j<pd;j++)ps+=" ";if(al[c]==="r")pts.push(" "+ps+cell+" ");else if(al[c]==="c"){var ll=Math.floor(pd/2),rr=pd-ll,lp="",rp="";for(var j=0;j<ll;j++)lp+=" ";for(var j=0;j<rr;j++)rp+=" ";pts.push(" "+lp+cell+rp+" ")}else pts.push(" "+cell+ps+" ")}res.push("|"+pts.join("|")+"|")}}return res}function findT(cm,ln){var st=ln,en=ln,ll=cm.lastLine();while(st>0&&t(cm.getLine(st-1)))st--;while(en<ll&&t(cm.getLine(en+1)))en++;if(st===en&&!t(cm.getLine(st)))return null;var li=[];for(var i=st;i<=en;i++)li.push(cm.getLine(i));return{start:st,end:en,lines:li}}function fmtAt(cm,ln){var tb=findT(cm,ln);if(!tb)return;var fmt=f(tb.lines);cm.operation(function(){for(var i=0;i<fmt.length;i++){var l=tb.start+i;cm.replaceRange(fmt[i],{line:l,ch:0},{line:l,ch:cm.getLine(l).length})}})}function fmtAll(cm){var i=0,ll=cm.lastLine(),n=0;while(i<=ll){if(t(cm.getLine(i))){var tb=findT(cm,i);if(tb){var fmt=f(tb.lines);cm.operation(function(){for(var j=0;j<fmt.length;j++){var l=tb.start+j;cm.replaceRange(fmt[j],{line:l,ch:0},{line:l,ch:cm.getLine(l).length})}});i=tb.end+1;n++;continue}}i++}return n}function gi(line,ch){var n=0;for(var i=0;i<ch;i++)line[i]==="|"&&n++;return n}function go(cm,ln,ci){var line=cm.getLine(ln),n=0;for(var i=0;i<line.length;i++)if(line[i]==="|"&&++n===ci){var st=i+1;while(st<line.length&&line[st]===" ")st++;cm.setCursor({line:ln,ch:st});return}}function tabN(cm){var cur=cm.getCursor(),line=cm.getLine(cur.line),ci=gi(line,cur.ch),cells=p(line);if(ci+1<=cells.length){fmtAt(cm,cur.line);go(cm,cur.line,ci+1);return}var nl=cur.line+1;while(nl<=cm.lastLine()&&s(cm.getLine(nl)))nl++;if(nl<=cm.lastLine()&&t(cm.getLine(nl))){fmtAt(cm,cur.line);go(cm,nl,1);return}fmtAt(cm,cur.line)}var el=document.querySelector(".CodeMirror");if(!el||!el.CodeMirror)return alert("CodeMirror not found");var cm=el.CodeMirror,ek=cm.getOption("extraKeys")||{};ek["Shift-Alt-F"]=function(cm){fmtAll(cm)};var ot=ek["Tab"];ek["Tab"]=function(cm){var cur=cm.getCursor();if(t(cm.getLine(cur.line))){tabN(cm);return}if(ot)return ot(cm);return CodeMirror.Pass};cm.setOption("extraKeys",ek);console.log("[Table Tidy] Bookmarklet loaded")}();
